<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>방명록</title>
  <link rel="stylesheet" href="../../2.PageElement/Tob_nav/Tob_nav.css" />
  <link rel="stylesheet" href="../../2.PageElement/Footer/Footer.css" />
  <link rel="stylesheet" href="../../2.PageElement/Cursor/cursor.css" />
  <style>
    html, body {
      height: 100%;
    }
    :root { --footer-safe: 0px; }
    .page-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    main.content {
      padding-top: 0; /* spacer will handle header height */
      padding-bottom: calc(var(--footer-safe) + 24px);
    }
    body {
      margin: 0;
      font-family: 'Pretendard', sans-serif;
      background-color: #000;
      color: #fff;
      overflow-x: hidden;
    }
    
      #nav-placeholder header .header-inner{
    max-width: 1600px;
    padding: 0;
    margin: 0 auto;
    display: flex;              /* 추가 */
    align-items: center;        /* 추가 */
    justify-content: space-between; /* 추가 */
    height: 100%;               /* 추가 */
  }
   /* === Tob_nav style (match Guest page) === */
   #nav-placeholder{
      position: sticky;
      top: 0;
      z-index: 1000;
      transition: transform .3s ease;
      will-change: transform;
    }
    body.nav-hidden #nav-placeholder{ transform: translateY(-110%); }
    .nav-spacer{ height: 0; }

    /* Visuals: black translucent + blur + thin divider */
    #nav-placeholder header{
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,.12);
      box-sizing: border-box;
      width: 100%;
      height: 90px;
      padding-left: 59px;
      padding-right: 60px;
    }
    

    /* Logo sizing */
    #nav-placeholder header .logo img{
      max-height: 38px;
      transform: translateY(2px);
    }
    #nav-placeholder .logo .logo-main{ font-size: 15px !important; }
    #nav-placeholder .logo .logo-sub { font-size: 15px !important; }

     /* 네비게이션: 스크롤 내리면 숨기고, 올리면 나타나도록 (레이아웃 점프 방지) */
     #nav-placeholder { position: sticky; top: 0; z-index: 1000; transition: transform .3s ease; }
    body.nav-hidden #nav-placeholder { transform: translateY(-110%); }

    /* Link typography */
    #nav-placeholder header a{
      font-family: 'Pretendard', sans-serif;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: .2px;
      text-decoration: none;
      color: #fff;
      padding: 8px 0;
    }
    #nav-placeholder header a:hover{ color:#ff3b3b; }
    #nav-placeholder header a.is-active{ color:#ff4d4d; font-weight:700; }
    /* — nav 간격/패딩 축소 — */
    #nav-placeholder nav ul{ gap:47px; }  /* 기존 48px → 32px */

    /* Flatten: disable dropdown menus entirely on Main page (like Guest) */
    #nav-placeholder nav ul li ul,
    #nav-placeholder .dropdown,
    #nav-placeholder .submenu,
    #nav-placeholder .has-dropdown > ul,
    #nav-placeholder .has-children > ul{
      display: none !important;
    }
    #nav-placeholder nav ul li:hover > ul{ display:none !important; }

    .guestbook-container {
      max-width: 1200px;
      margin: 24px auto 0; 
      padding: 20px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 40px;
      background: none;
      border: none;
      border-radius: 0;
      box-shadow: none;
    }

    .guestbook-title {
      font-family: 'Times New Roman', serif;
      font-size: 4.5rem;
      color: white;
      text-align: center;
      margin-bottom: 2rem;
    }

    hr {
      border-color: #ffffff;
    }

    .write-button-wrapper {
      text-align: center;
      margin-bottom: 2rem;
    }

    #toggleWriteForm {
      background-color: #ff4d4d;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
    }

    .guestbook-form-container.hidden {
      display: none;
    }

    .search-bar {
      margin: 2rem auto;
      display: flex;
      justify-content: center;
    }

    .search-bar input {
      padding: 0.8rem 1rem;
      border-radius: 20px;
      border: 2px solid white;
      background-color: #222;
      color: white;
      font-size: 1rem;
      width: 300px;
    }

    .search-bar input::placeholder {
      color: #ffcccc;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      align-items: stretch; /* 중앙 정렬 제거, 좌우로 꽉 차게 */
    }

    input, textarea {
      padding: 1rem;
      background: #222;
      color: white;
      border-radius: 12px;
      font-size: 1rem;
      border: 1px solid #333;
      clip-path: none;
      width: 100%;
      margin: 0 auto;
      box-sizing: border-box;
      max-width: 100%;
    }

    input:focus, textarea:focus{
      outline: none;
      border-color: #ff4d4d;
      box-shadow: 0 0 0 2px rgba(255,77,77,0.2);
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    button {
      padding: 0.8rem;
      background-color: #ff4d4d;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 80%;
      margin: 0 auto;
      box-sizing: border-box;
    }

    .guestbook-form-container button[type="submit"] {
      background-color: #fff;
      color: #000;
      border: 1px solid #000;
    }
    .guestbook-form-container button[type="submit"]:hover {
      background-color: #000; /* invert on hover */
      color: #fff;
      border-color: #000;
    }

    button:hover {
      background-color: #e60000;
    }

    .message {
      background: white;
      border-radius: 10px;
      color: black;
      font-weight: 500;
      padding: 0.75rem 1rem; /* roomier */
      margin: 0;
      flex: 0 0 calc((100% - 2rem) / 3);
      box-sizing: border-box;
      display: block;
      position: relative;
      min-height: 72px; /* not too short */
      align-self: flex-start;
    }

    .message-list {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: flex-start;
      align-items: flex-start;
      align-content: flex-start;
    }


    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.25rem;          /* tighter spacing */
      margin-top: 1rem;
      line-height: 1;
      margin-bottom: 8px;
    }
    .pagination .page-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      font-weight: 700;
      color: #aaa;
      background: transparent;
      cursor: pointer;
      user-select: none;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    .pagination .page-link.active {
      background: #ff4d4d; /* red background */
      color: #fff;
    }
    .pagination .page-link:hover:not(.active) {
      background: rgba(255,77,77,0.1);
      color: #ff4d4d;
    }

    .hidden {
      display: none;
    }

    /* Two-column layout */
    .guestbook-left {
      flex: 0 0 40%;
      display: flex;
      flex-direction: column;
      align-self: flex-start;
      position: sticky;
      top: 120px; /* keep previous spacing under 90px header */
    }
    .guestbook-right { flex: 1 1 60%; max-width: 700px; }

    /* Title block on the left */
    .guestbook-left h1 { 
      font-family: 'Times New Roman', serif;
      font-size: 4.5rem;
      color: #fff;
      margin: 36px 0 12px 0; /* moved further down */
    }
    .guestbook-left p { color: #ddd; margin: 0; }

    /* Form + inputs on the left (equal widths) */
    .guestbook-left .write-button-wrapper { text-align: left; margin-bottom: 16px; }
    .guestbook-left .guestbook-form-container {
      margin-top: 16px; /* keep small gap, no push to bottom */
      margin-bottom: 20px;
    }
    .guestbook-left form { display: flex; flex-direction: column; gap: 12px; max-width: 520px; }
    .guestbook-left input[type="text"],
    .guestbook-left textarea,
    .guestbook-left button[type="submit"],
    .guestbook-left #toggleWriteForm {
      width: 100%;
      box-sizing: border-box;
    }

    /* Message list lives on the right */
    .guestbook-right .message-list { justify-content: flex-start; }

    /* === Guest message edit UI === */
    .message .msg-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: none; /* hidden until pencil clicked */
      gap: .35rem;
      margin: 0;
    }
    .message .msg-actions button {
      background: #222;
      color: #fff;
      border: 1px solid #444;
      padding: .28rem .48rem;
      border-radius: 6px;
      font-size: .78rem;
      cursor: pointer;
    }
    .message .msg-actions button:hover { background:#333; }
    .message.show-actions .msg-actions { display: flex; }
    .message .edit-toggle {
      position: absolute; top: 8px; right: 8px;
      background: transparent; border: 0; cursor: pointer;
      font-size: 18px; line-height: 1; padding: 2px; color: #555;
    }
    .message .edit-toggle:hover { color: #000; }
    .message .edit-form {
      display:flex;
      flex-direction:column;
      gap:.6rem;
    }
    .message .edit-form input[type="text"],
    .message .edit-form textarea {
      width:100%;
      box-sizing:border-box;
      border:1px solid #bbb;
      border-radius:8px;
      padding:.6rem .7rem;
      font-size: .95rem;
      background:#fafafa;
      color:#111;
    }
    .message .edit-form textarea { min-height: 80px; resize: vertical; }

    /* Guest message text: scroll inside the card (no page jump) */
    .message p.msg-text {
      line-height: 1.5;
      margin: 0;
      color: #000;
      background: transparent;
      font-size: 1rem;
      white-space: normal;
      max-height: 160px;      /* visible area */
      overflow-y: auto;       /* vertical scroll for long text */
      -webkit-overflow-scrolling: touch; /* smooth on iOS */
    }
    /* 모바일(800px 이하)에서 guestbook-title 중앙정렬 및 레이아웃 정돈 */
    @media (max-width: 800px) {
      .guestbook-title {
        text-align: center;
        margin: 0 auto 1.5rem auto;
        font-size: 3rem;
      }
      .guestbook-container {
        flex-direction: column;
        gap: 20px;
        padding: 16px;
      }
      .guestbook-left {
        position: static;   /* 스티키 해제 */
        top: auto;
        align-items: center;
      }
      .guestbook-left form { 
        width: 100%;
        max-width: 520px;
      }
      .guestbook-right { 
        width: 100%;
        max-width: 100%;
      }
    }


    /* Saved message layout: To → Message → From */
    .message .kv { display:flex; flex-direction:column; gap:.3rem; }
    .message .kv .row { display:flex; flex-direction:column; gap:.1rem; }
    .message .kv .label { font-size:.85rem; font-weight:700; color:#666; letter-spacing:.2px; }
    .message .kv .value { font-size:1rem; font-weight:700; color:#111; }
    .message .kv .msg-text { margin-top:0; }
    .message .kv .row.message .label { display:none; }


    @media (max-width: 900px) {
      .guestbook-container { flex-direction: column; gap: 24px; }
      .guestbook-left, .guestbook-right { flex: 1 1 auto; max-width: 100%; }
    }

.guestbook-right {
  flex: 1 1 auto;
  max-width: 700px;
  display: flex;
  flex-direction: column;
  min-height: 0; /* 내부 스크롤 허용 */
}

.message-list {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: flex-start;
  flex: 1 1 auto;       /* 남은 공간 전부 차지 */
  min-height: 0;
  padding-bottom: calc(var(--footer-safe) + 104px);
  overflow: visible;    /* 리스트 자체 스크롤 제거 → 페이지가 스크롤 */
  align-items: flex-start;
  align-content: flex-start;
}

#pagination{
  position: fixed;
  left: 50%;
  bottom: calc(var(--footer-safe) + 0px);
  transform: translateX(-50%);
  z-index: 10;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  padding: 6px 10px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.25);
}

/* Restore compact spacing: Pager is not fixed, so minimal bottom padding is sufficient */



    /* ===== Project list: equal-sized tiles ===== */
.project ul,
.projects ul,
.project-list { 
  display: grid; 
  grid-template-columns: repeat(3, minmax(0, 1fr)); 
  gap: 16px; 
  list-style: none; 
  padding: 0; 
  margin: 0; 
}

.project ul li,
.projects ul li,
.project-list li {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid #333;
  border-radius: 12px;
  background: #111;
  color: #fff;
  overflow: hidden;
  /* Make every tile the exact same size */
  aspect-ratio: 1 / 1;          /* perfect square */
  min-height: 180px;            /* floor for very narrow screens */
}

/* If an image or thumbnail exists inside li, make it fit uniformly */
.project ul li img,
.projects ul li img,
.project-list li img {
  width: 100%;
  height: 100%;
  object-fit: cover;   /* consistent crop */
  display: block;
}

/* Optional inner content wrapper support */
.project ul li > a,
.projects ul li > a,
.project-list li > a,
.project ul li > .card,
.projects ul li > .card,
.project-list li > .card {
  position: absolute; inset: 0; 
  display: flex; align-items: center; justify-content: center; 
  text-decoration: none; color: inherit;
  padding: 12px;
}

/* Responsive columns */
@media (max-width: 1000px) {
  .project ul, .projects ul, .project-list { grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width: 560px) {
  .project ul, .projects ul, .project-list { grid-template-columns: 1fr; }
}

    /* Stick footer to the bottom of the viewport, full-width */
    #footer-placeholder {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000; /* above pager */
      width: 100%;
    }
    #footer-placeholder footer,
    #footer-placeholder .footer,
    #footer-placeholder .site-footer { position: relative; z-index: 1000; }

/* Keep existing look & feel for buttons */
#pagination .page-link.active { background: #ff4d4d; color: #fff; }
#pagination .page-link:hover:not(.active) { background: rgba(255,77,77,0.1); color: #ff4d4d; }

/* Mobile tweak: nudge up a little on very short screens */
@media (max-height: 620px) {
  #pagination { bottom: calc(var(--footer-safe) + 0px); }
}

  </style>
</head>
<body>
  <div class="page-wrapper">
    <div id="nav-placeholder"></div>
    <div id="cursor-placeholder"></div>
    <main class="content">
      <div class="guestbook-container">
        <div class="guestbook-left">
          <h1 class="page-title guestbook-title">GUEST BOOK</h1>
          <div class="write-button-wrapper">
            <button id="toggleWriteForm">✍ 글쓰기</button>
          </div>
          <div class="guestbook-form-container hidden">
            <form id="guestForm">
              <input type="text" id="name" name="name" placeholder="To" required />
              <textarea id="message" name="message" placeholder="메시지를 남겨주세요" required></textarea>
              <input type="text" id="from" name="from" placeholder="From" required />
              <button type="submit">남기기</button>
            </form>
          </div>
        </div>
        <div class="guestbook-right">
          <div class="message-list" id="messageList"></div>
          <div class="pagination" id="pagination"></div>
        </div>
      </div>
    </main>
    <div id="footer-placeholder"></div>
  </div>
  <script> 
    // 네비게이션 HTML 로드 (Project.page 스타일 우선 적용) + 로고 교체 + 링크 정규화
    (async function loadProjectNav(){
      const root = document.getElementById('nav-placeholder');
      if (!root) return;
      const basePath = '../../2.PageElement/Tob_nav/';
      const candidates = [
        basePath + 'Tob_nav_project.html', // Project 페이지와 동일 네비 우선
        basePath + 'Tob_nav.html'          // 없으면 기본 네비 사용
      ];
      let html = '';
      for (const url of candidates){
        try{
          const res = await fetch(url, { cache: 'no-store' });
          if (res.ok){ html = await res.text(); break; }
        }catch(_){ /* try next */ }
      }
      if (!html){ console.warn('[guest] nav load failed'); return; }

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      // 로고 이미지 교체 (장미로고 + 텍스트 로고)
      const logoContainer = doc.querySelector('.logo');
      if (logoContainer) {
        const imgs = logoContainer.querySelectorAll('img');
        if (imgs.length > 0) {
          imgs[0].outerHTML = '<img src="../../1.Picture/1.%2027th%20Graduation/BLOOM_LOGO/1.png" alt="장미로고" />';
          if (imgs.length > 1) {
            imgs[1].setAttribute('src', '../../1.Picture/1.%2027th%20Graduation/BLOOM_LOGO/BLOOM_LOGOTAXT.png');
          }
        }
      }

      // base 태그 제거 (상대경로 꼬임 방지)
      const baseEl = doc.querySelector('base');
      if (baseEl) baseEl.remove();

      // 링크 정규화: 현재 디렉토리(/2025) 기준으로 매핑
      const baseDir = location.pathname.replace(/\/[^/]*$/, '');
      const toURL = (file) => `${baseDir}/${file}`.replace(/\/{2,}/g, '/');
      const linkMap = {
        'home': toURL('Main.html'),
        'about': toURL('About.html'),
        'project': toURL('Project.html'),
        'designer': toURL('Designer.html'),
        'guest': toURL('Guest.html'),
        'guest book': toURL('Guest.html'),
        'guestbook': toURL('Guest.html'),
      };

      const logoLink = doc.querySelector('a.logo, .logo a');
      if (logoLink) logoLink.setAttribute('href', linkMap['home']);

      doc.querySelectorAll('a[href]').forEach(a => {
        const text = (a.textContent || '').trim().toLowerCase();
        const href = (a.getAttribute('href') || '').trim();
        if (linkMap[text]) { a.setAttribute('href', linkMap[text]); return; }
        if (/about/i.test(href))          a.setAttribute('href', linkMap['about']);
        else if (/project/i.test(href))   a.setAttribute('href', linkMap['project']);
        else if (/designer/i.test(href))  a.setAttribute('href', linkMap['designer']);
        else if (/guest(\s*book)?/i.test(href)) a.setAttribute('href', linkMap['guest']);
        else if (/main|home|index/i.test(href))  a.setAttribute('href', linkMap['home']);
      });

      // 현재 페이지 활성화 표시
      const currentName = location.pathname.split('/').pop().toLowerCase();
      doc.querySelectorAll('a[href]').forEach(a => {
        const target = (a.getAttribute('href') || '').toLowerCase();
        if (target.endsWith(currentName)) {
          a.setAttribute('aria-current', 'page');
          a.classList.add('is-active');
        }
      });

      // DOM에 삽입
      root.innerHTML = doc.body.innerHTML;

      // Remove dropdown structures from the injected navigation
      (function stripDropdowns(){
        const navRoot = document.getElementById('nav-placeholder');
        if (!navRoot) return;
        // Remove submenu <ul>s
        navRoot.querySelectorAll('nav ul ul, .dropdown, .submenu, .menu .sub, [aria-haspopup="true"] > ul').forEach(el=>{
          try{ el.remove(); }catch(_){ el.parentNode && el.parentNode.removeChild(el); }
        });
        // Remove dropdown indicator classes to avoid CSS hooks
        navRoot.querySelectorAll('.has-dropdown, .has-children, .dropdown-toggle').forEach(el=>{
          el.classList.remove('has-dropdown','has-children','dropdown-toggle');
          el.removeAttribute('aria-haspopup');
          el.removeAttribute('aria-expanded');
        });
      })();


      // --- 네비 높이만큼 스페이서 확보 (겹침 방지) ---
      (function syncNavSpacer(){
        const root = document.getElementById('nav-placeholder');
        if (!root) return;
        let spacer = document.querySelector('.nav-spacer');
        if (!spacer) {
          spacer = document.createElement('div');
          spacer.className = 'nav-spacer';
          root.after(spacer);
        }
        let header = root.querySelector('header') || root.firstElementChild;
        function setSpacer(){
          const ref = header || root.firstElementChild;
          if (ref && spacer){ spacer.style.height = (ref.offsetHeight + 8) + 'px'; }
        }
        setSpacer();
        window.addEventListener('resize', setSpacer, { passive:true });
        setTimeout(setSpacer, 150);
        setTimeout(setSpacer, 600);
        try {
          const ro = new ResizeObserver(setSpacer);
          if (header) ro.observe(header);
          const mo = new MutationObserver(()=>{ header = root.querySelector('header') || root.firstElementChild; setSpacer(); });
          mo.observe(root, { childList:true, subtree:true, attributes:true });
        } catch(_) {}
        console.debug('[guest] nav spacer synced');
      })();

      // --- 스크롤 내릴 때 숨기고 올리면 보이기 ---
      console.debug('[guest] hide-on-scroll binding');
      (function hideNavOnScroll(){
        if (window.__navHideBound) return;
        window.__navHideBound = true;
        let prevY = window.pageYOffset || 0;
        window.addEventListener('scroll', function(){
          const y = window.pageYOffset || 0;
          if (y > prevY + 8 && y > 40) document.body.classList.add('nav-hidden');
          else if (y < prevY - 8) document.body.classList.remove('nav-hidden');
          prevY = y;
        }, { passive:true });
      })();
    })();
    // 푸터 HTML 로드 + 고정 페이지네이션과 겹치지 않도록 안전 여백 계산
    fetch('../../2.PageElement/Footer/Footer.html')
      .then(res => res.text())
      .then(data => {
        const root = document.getElementById('footer-placeholder');
        if (root) root.innerHTML = data;

        const setFooterSafe = () => {
          const h = root.offsetHeight || 0;
          document.documentElement.style.setProperty('--footer-safe', h + 'px');
        };
        setFooterSafe();

        const ro = new ResizeObserver(setFooterSafe);
        ro.observe(root);
        window.addEventListener('resize', setFooterSafe, { passive: true });
      });

    // 커서 HTML 삽입 + 초기화 (부드러운 추적)
    (function loadCursor(){
      const root = document.getElementById('cursor-placeholder');
      if (!root) return;

      function initRoseCursor(){
        const cursor = document.querySelector('.cursor-dot');
        if (!cursor) return false;
        // 중복 RAF 방지 (재초기화 시 루프 중첩 방지)
        if (cursor.dataset.raf === 'on') return true;

        // 성능 힌트: transform 업데이트 가속
        cursor.style.willChange = 'transform';

        let x = 0, y = 0, tx = 0, ty = 0, started = false;
        const ease = 0.62; // ↑ 값이 클수록 더 빠르게 따라옴 (기존 0.25)

        function raf(){
          tx += (x - tx) * ease;
          ty += (y - ty) * ease;
          cursor.style.transform = `translate3d(calc(${tx}px - 50%), calc(${ty}px - 50%), 0)`;
          requestAnimationFrame(raf);
        }

        document.addEventListener('mousemove', (e)=>{
          x = e.clientX; y = e.clientY;
          if (!started){ tx = x; ty = y; started = true; }
        }, {passive:true});

        cursor.dataset.raf = 'on';
        requestAnimationFrame(raf);
        return true;
      }

      fetch('../../2.PageElement/Cursor/cursor.html', {cache: 'no-store'})
        .then(res => res.text())
        .then(html => {
          root.innerHTML = html;
          if (!initRoseCursor()) {
            const mo = new MutationObserver(()=>{ if (initRoseCursor()) mo.disconnect(); });
            mo.observe(root, {childList:true, subtree:true});
          }
        })
        .catch(err => console.error('Cursor load failed:', err));
    })();

    const API_URL = "https://script.google.com/macros/s/AKfycbzv2q6tQP8CILNnkPYhKy-VF_ugJq4XaI4v79XTRbUsU0ZaBKOxJojnJGZyEgcBz1vBMA/exec";
    const messagesPerPage = 6; // 3 columns x 2 rows per page
let messages = [];
let currentPage = 1;
// Clear stale local cache on every visit (ensure fresh fetch from API)
try { localStorage.removeItem('guestbook-cache'); } catch (_) {}

    // --- helpers to avoid HTML injection when rendering user text ---
    function escHtml(str){
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    function escAttr(str){ return escHtml(str); }

    function renderMessages() {
      const messageList = document.getElementById("messageList");
      const pagination = document.getElementById("pagination");
      // Hide pager when there are no messages; show when messages exist
      if (messages.length === 0) {
        messageList.innerHTML = "";
        pagination.innerHTML = "";
        pagination.classList.add("hidden");
      } else {
        pagination.classList.remove("hidden");
      }
      messageList.innerHTML = "";
      pagination.innerHTML = "";

      const start = (currentPage - 1) * messagesPerPage;
      const end = start + messagesPerPage;
      const paginatedItems = messages.slice(start, end);

      paginatedItems.forEach((item, iLocal) => {
        const idx = start + iLocal;
        const { name, message, editing } = item;
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message");

        if (editing) {
          msgDiv.innerHTML = `
            <form class="edit-form" data-index="${idx}">
              <input type="text" id="edit-name-${idx}" value="${escAttr(name)}" placeholder="To" required />
              <input type="text" id="edit-from-${idx}" value="${escAttr(item.from || '')}" placeholder="From" required />
              <textarea id="edit-message-${idx}" required>${escHtml(message)}</textarea>
              <div class="msg-actions">
                <button type="submit" class="save-btn">저장</button>
                <button type="button" class="cancel-btn">취소</button>
                <button type="button" class="delete-btn" data-index="${idx}">삭제</button>
              </div>
            </form>
          `;
        } else {
          const safeName = escHtml(name);
          const safeMsg = escHtml(message).replace(/\n/g,'<br>');
          msgDiv.innerHTML = `
  <button class="edit-toggle" aria-label="수정 메뉴 열기">✏️</button>
  <div class="kv">
    <div class="row to"><span class="label">To</span><span class="value">${safeName}</span></div>
    <div class="row message"><span class="label">Message</span><p class="msg-text">${safeMsg}</p></div>
    <div class="row from"><span class="label">From</span><span class="value">${escHtml(item.from || safeName)}</span></div>
  </div>
  <div class="msg-actions">
    <button class="edit-btn" data-index="${idx}">수정</button>
    <button class="delete-btn" data-index="${idx}">삭제</button>
  </div>`;
        }

        messageList.appendChild(msgDiv);
      });

      const pageCount = Math.max(1, Math.ceil(messages.length / messagesPerPage));
      for (let i = 1; i <= pageCount; i++) {
        const link = document.createElement("span");
        link.className = "page-link" + (i === currentPage ? " active" : "");
        link.textContent = i;
        link.addEventListener("click", () => {
          currentPage = i;
          renderMessages();
        });
        pagination.appendChild(link);
        if (i < pageCount) {
          const sep = document.createElement("span");
          sep.className = "page-sep";
          sep.textContent = "·";
          sep.style.margin = "0 .1rem";
          sep.style.opacity = "0.6";
          pagination.appendChild(sep);
        }
      }
      document.documentElement.style.setProperty('--footer-safe', (document.getElementById('footer-placeholder').offsetHeight || 0) + 'px');
    }

  // (kept above code untouched)
  document.getElementById("guestForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const form = e.currentTarget;

  const name = document.getElementById("name").value.trim();
  const message = document.getElementById("message").value.trim();
  const from = document.getElementById("from").value.trim();

  if (!name || !message) {
    alert("이름과 메시지를 입력해주세요.");
    return;
  }

  // ✅ 프리플라이트 없는 '단순요청'으로 전송 (CORS 에러 회피)
  const body = new URLSearchParams();
  body.set("name", name);
  body.set("message", message);
  body.set("from", from);

  try {
    await fetch(API_URL, {
      method: "POST",
      mode: "no-cors",   // 응답은 opaque가 되지만 요청은 정상 전송됨
      body                // 절대 headers에 Content-Type을 강제로 넣지 마!
    });
  } catch (err) {
    // 진짜 네트워크 끊김 같은 경우만 콘솔로 보고, 사용자에겐 알림 안 띄움
    console.warn("submit network error:", err);
  }

  // ✅ 낙관적 업데이트: 바로 화면에 반영
  const tempId = 'temp-' + Date.now();
  messages.unshift({ id: tempId, name, message, from });
  currentPage = 1;
  renderMessages();
  form.reset();

  // ✅ Apps Script가 시트에 쓰는 데 약간 시간 걸림 → 잠깐 후 실제 데이터로 동기화
  setTimeout(loadInitialMessages, 1200);
});

    document.getElementById("toggleWriteForm").addEventListener("click", function () {
      const formContainer = document.querySelector(".guestbook-form-container");
      formContainer.classList.toggle("hidden");
    });

    // --- delegated edit/delete handlers on the message list ---
    document.getElementById('messageList').addEventListener('click', (e) => {
      const editBtn = e.target.closest('.edit-btn');
      const cancelBtn = e.target.closest('.cancel-btn');
      const delBtn = e.target.closest('.delete-btn');
      const toggleBtn = e.target.closest('.edit-toggle');
      if (toggleBtn) {
        const card = toggleBtn.closest('.message');
        if (card) card.classList.toggle('show-actions');
        return;
      }
      if (editBtn) {
        const idx = parseInt(editBtn.dataset.index, 10);
        if (!isNaN(idx) && messages[idx]) {
          messages[idx].editing = true;
          renderMessages();
        }
        return;
      }
      if (cancelBtn) {
        const form = e.target.closest('.edit-form');
        const idx = form ? parseInt(form.dataset.index, 10) : -1;
        if (!isNaN(idx) && messages[idx]) {
          messages[idx].editing = false;
          renderMessages();
        }
        return;
      }
      if (delBtn) {
        const idx = parseInt(delBtn.dataset.index, 10);
        if (!isNaN(idx) && messages[idx]) {
          const target = messages[idx];
          if (!target.id || String(target.id).startsWith('temp-')) {
            alert('이 글은 아직 서버에 저장된 ID가 없어 삭제가 불가합니다.\n잠시 후 새로고침(F5) 후 다시 시도해주세요.');
            return;
          }
          if (confirm('정말 삭제하시겠어요?')) {
            fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ action: "delete", id: target.id })
            })
            .then(res => {
              // 성공/실패와 관계없이 UI에서는 제거, 필요시 추후 보강
              messages.splice(idx, 1);
              renderMessages();
            })
            .catch(() => {
              alert("삭제 중 오류가 발생했습니다.");
            });
          }
        }
        return;
      }
    });
    

    document.getElementById('messageList').addEventListener('submit', (e) => {
      const form = e.target.closest('.edit-form');
      if (!form) return;
      e.preventDefault();
      const idx = parseInt(form.dataset.index, 10);
      if (isNaN(idx) || !messages[idx]) return;
      const newName = document.getElementById(`edit-name-${idx}`).value;
      const newFrom = document.getElementById(`edit-from-${idx}`).value;
      const newMsg  = document.getElementById(`edit-message-${idx}`).value;
      messages[idx] = { name: newName, from: newFrom, message: newMsg, editing: false };
      renderMessages();
    });

    async function loadInitialMessages(){
      try {
        const res = await fetch(API_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("fetch failed: " + res.status);
        const rows = await res.json();
        messages = Array.isArray(rows) ? rows.map(r => ({
          id: r.id || "",
          name: r.name || "",
          message: r.message || "",
          from: r.from || (r.name || ""),
        })) : [];
        currentPage = 1;
        renderMessages();
      } catch (e) {
        console.warn("[guest] loadInitialMessages fallback to local cache", e);
        messages = [];
        currentPage = 1;
        renderMessages();
      }
    }

    // 초기 데이터 로드
    loadInitialMessages();

    // --- 화면 크기 변화 시 모바일 페이지로 자동 전환 ---
    (function handleResponsiveRedirect(){
      function checkViewport() {
        const width = window.innerWidth;
        const current = location.pathname.toLowerCase();
        if (width < 800 && !current.includes('guest-mobile.html')) {
          location.href = 'Guest-mobile.html';
        }
      }
      window.addEventListener('resize', checkViewport);
      window.addEventListener('load', checkViewport);
    })();

    
  </script>
</body>
</html>