<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guest-Mobile</title>
  <link rel="preload" as="image" href="../../1.Picture/1. 27th Graduation/BLOOM_LOGO/1.png" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&amp;display=swap');
    :root{
      --line: rgba(255,255,255,.12);
      --footer-safe: 36px;  /* footer height reserve (统一 36px) */
      --nav-h: 64px;        /* canonical TUVD mobile header height */
      --header-h: var(--nav-h); /* keep legacy var for layout calc */
      --card-gap: 12px;
      --card-radius: 12px;
    }
    html,body{ margin:0; padding:0; background:#000; color:#fff; }
    body{ font-family: Pretendard, system-ui, -apple-system, sans-serif; overflow-x:hidden; padding-top: var(--header-h); }
    
    /* ===== 페이지 타이틀 / 섹션 ===== */
    .wrap{ padding: 16px 16px calc(var(--footer-safe) + 16px); }
    .wrap {
      overflow-y: auto;
      max-height: calc(100vh - var(--header-h) - var(--footer-safe));
    }
    .hero-title{
      margin: 10px auto 12px;
      font-family: 'Playfair Display', serif;
      font-size: 34px;
      font-weight: 700;
      letter-spacing: .2px;
      text-align: center;
    }

    /* ===== 글쓰기 토글 / 폼 ===== */
    .write-toggle{ display:flex; justify-content:center; margin: 8px 0 14px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 16px; border-radius:10px; border:1px solid rgba(255,255,255,.18);
      background:#111; color:#fff; font-weight:800; cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }
    .form-box{
      display:none; margin:0; padding:12px; border:1px solid rgba(255,255,255,.14);
      border-radius:12px; background:rgba(255,255,255,.03);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    }
    .form-box.show{ display:block; }
    .form-box form{ display:flex; flex-direction:column; gap:10px; }
    .form-box input, .form-box textarea{
      width:100%; box-sizing:border-box;
      padding:12px 14px; border-radius:10px; border:1px solid #333;
      background:#1a1a1a; color:#fff; font-size:14px;
    }
    .form-box textarea{ min-height:110px; resize:vertical; }
    .form-box input:focus, .form-box textarea:focus{
      outline:none; border-color:#ff4d4d; box-shadow:0 0 0 2px rgba(255,77,77,.2);
    }
    .form-submit{
      margin-top:4px; width:100%; background:#fff; color:#000; border:1px solid #000;
      font-weight:900; padding:10px 16px; border-radius:10px; cursor:pointer;
    }
    .form-submit:hover{ background:#000; color:#fff; }

    /* ===== 메시지 카드 ===== */
    .list{
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--card-gap);
      margin-top: 18px;
      max-height: calc(100vh - var(--header-h) - var(--footer-safe) - 160px);
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.2) transparent;
    }
    .list::-webkit-scrollbar {
      width: 6px;
    }
    .list::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.2);
      border-radius: 3px;
    }
    .card{
      position:relative; border-radius: var(--card-radius);
      background:#fff; color:#000; padding:12px 14px;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      min-height: 74px;
    }
    .card .to{ font-weight:800; font-size:14px; color:#111; }
    .card .msg{
      margin:6px 0 8px;
      line-height:1.5;
      font-size:14px;
      overflow-y: auto;
      max-height: 120px;
      scrollbar-width: thin;
      scrollbar-color: rgba(0,0,0,.3) transparent;
    }
    .card .msg::-webkit-scrollbar {
      width: 4px;
    }
    .card .msg::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,.3);
      border-radius: 2px;
    }
    .card .from{ font-weight:700; font-size:13px; color:#333; }
    .card .edit-toggle{
      position:absolute; top:8px; right:8px;
      background:transparent; border:0; font-size:18px; cursor:pointer; color:#777;
    }
    .card .actions{ display:none; position:absolute; top:8px; right:8px; gap:6px; }
    .card.show-actions .actions{ display:flex; }
    .card .actions .mini{
      padding:4px 8px; border-radius:8px; border:1px solid #444; background:#222; color:#fff; font-size:12px;
    }

    /* ===== 페이지네이션 (고정) ===== */
    .pager{
      position:fixed; left:50%; bottom: calc(var(--footer-safe) + 8px);
      transform: translateX(-50%);
      display:flex; gap:6px; align-items:center;
      background:rgba(0,0,0,.55); padding:6px 10px; border-radius:10px;
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      z-index: 900;
    }
    .pager .page{ width:34px; height:34px; border-radius:8px; display:flex; align-items:center; justify-content:center;
      font-weight:800; color:#ddd; border:1px solid rgba(255,255,255,.16); background:transparent; }
    .pager .page.active{ background:#ff4d4d; color:#fff; border-color: transparent; }
    .pager .page:not(.active):hover{ background: rgba(255,77,77,.1); color:#ff4d4d; }

    footer{
      position:fixed;
      left:0; right:0; bottom:0;
      width:100%;
      background:#000;
      color:#eee;
      border-top:1px solid var(--line);
      height:var(--footer-safe);      /* 36px */
      min-height:var(--footer-safe);
      padding:0 12px;                 /* vertical 0 to keep exact height */
      box-sizing:border-box;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      line-height:1;                  /* eliminate browser default variance */
      z-index:800;
    }

  </style>
</head>
<body>
  <!-- Shared Mobile Header mount point -->
  <div id="mobile-header-host" data-src="../../2.PageElement/Mobile-header/mobile-header.html"></div>

  <!-- 본문 -->
  <main class="wrap">
    <h1 class="hero-title">GUEST BOOK</h1>

    <div class="write-toggle">
      <button id="toggleWriteForm" class="btn">✍ 글쓰기</button>
    </div>

    <section id="writeBox" class="form-box" aria-hidden="true">
      <form id="guestForm" name="guestbook" method="POST" data-netlify="true" netlify-honeypot="bot-field">
        <input type="hidden" name="form-name" value="guestbook" />
        <input type="text" id="name" name="name" placeholder="To" required />
        <textarea id="message" name="message" placeholder="메시지를 남겨주세요" required></textarea>
        <input type="text" id="from" name="from" placeholder="From" required />
        <button type="submit" class="form-submit">남기기</button>
      </form>
    </section>

    <section class="list" id="messageList"></section>
    <div class="pager" id="pagination" role="navigation" aria-label="페이지 이동"></div>
  </main>

  <footer>© TUVD 27th Graduate Exhibition • BLOOM</footer>

  <!-- 숨김 폼(넷리파이 빌드용) -->
  <form name="guestbook" method="POST" data-netlify="true" netlify-honeypot="bot-field" style="position:absolute;left:-9999px;opacity:0;pointer-events:none;">
    <input type="hidden" name="form-name" value="guestbook" />
    <input name="name" />
    <textarea name="message"></textarea>
    <input name="from" />
    <input type="text" name="bot-field" />
    <button type="submit">남기기</button>
  </form>

  <script>
    // === Mount shared Mobile Header (fetch + inject) ===
    (function mountMobileHeader(){
      var host = document.getElementById('mobile-header-host');
      if(!host) return;
      var src = host.getAttribute('data-src');
      if(!src){ console.warn('mobile-header: data-src not set'); return; }

      fetch(src, { cache: 'no-store' })
        .then(function(res){
          if(!res.ok) throw new Error('HTTP ' + res.status);
          return res.text();
        })
        .then(function(html){
          host.innerHTML = html;

          // === Normalize header links to /2025/*-mobile.html ===
          (function fixHeaderLinks(){
            var scope = host; // limit to injected header only
            var anchors = scope.querySelectorAll('a[href]');
            anchors.forEach(function(a){
              var raw = a.getAttribute('href');
              if (!raw) return;
              // keep absolute URLs, hashes, and protocols untouched
              if (/^(https?:)?\/\//i.test(raw)) return;
              if (raw.startsWith('#')) return;
              if (raw.startsWith('mailto:') || raw.startsWith('tel:')) return;

              // extract the last path segment without query/hash
              var cleaned = raw.replace(/[#?].*$/, '');
              var segs = cleaned.split('/').filter(Boolean);
              var last = segs.length ? segs[segs.length - 1] : cleaned;
              var base = last.replace(/\.html?$/i, '').toLowerCase();

              // normalize some common variants
              base = base
                .replace(/^index$/, 'main')
                .replace(/^home$/, 'main')
                .replace(/^projects?$/, 'project')
                .replace(/^designs?$/, 'design')
                .replace(/^designer(s)?$/, 'design')
                .replace(/^guests?$/, 'guest');

              function toMobile(name){
                switch(name){
                  case 'main':    return '/2025/Main-mobile.html';
                  case 'project': return '/2025/Project-mobile.html';
                  case 'design':
                  case 'designer':
                    return '/2025/Design-mobile.html';
                  case 'about':   return '/2025/About-mobile.html';
                  case 'guest':   return '/2025/Guest-mobile.html';
                  case 'gallery': return '/2025/Gallery-mobile.html';
                  default:        return null;
                }
              }

              var target = toMobile(base);
              if (target) a.setAttribute('href', target);
            });
          })();

          // Wire hamburger interactions scoped to injected header
          var btn     = host.querySelector('#menuBtn');
          var menu    = host.querySelector('#mMenu');
          var overlay = host.querySelector('#menuOverlay');

          function toggle(){
            var open = !document.body.classList.contains('nav-open');
            document.body.classList.toggle('nav-open', open);
            if(btn){
              btn.setAttribute('aria-expanded', open ? 'true' : 'false');
              btn.setAttribute('aria-label', open ? '메뉴 닫기' : '메뉴 열기');
            }
          }

          if(btn){ btn.addEventListener('click', toggle); }
          if(overlay){ overlay.addEventListener('click', toggle); }
          if(menu){
            menu.addEventListener('click', function(e){
              if(e.target.closest('a')){
                document.body.classList.remove('nav-open');
                if(btn){
                  btn.setAttribute('aria-expanded', 'false');
                  btn.setAttribute('aria-label', '메뉴 열기');
                }
              }
            });
          }
        })
        .catch(function(err){
          console.error('Failed to load mobile header:', err);
        });
    })();

    // ===== 라우팅: 화면 너비 기준 (<=639px: Guest-mobile.html, >=640px: Guest.html) =====
    (function responsiveRoute(){
      const DESKTOP_BASE = 'Guest';
      const MOBILE_BASE  = 'Guest-mobile';
      function isOnBase(base){
        const p = location.pathname.toLowerCase().replace(/\/+$/, '');
        const b = base.toLowerCase().replace(/\.html?$/, '');
        return (
          p.endsWith('/'+b) ||
          p.endsWith('/'+b+'.html') ||
          p.endsWith('/'+b+'/') ||
          p.endsWith('/'+b+'/index.html')
        );
      }
      function goToBase(base){
        const baseDir = location.pathname.replace(/[^/]*$/, '');
        const file = base + '.html';
        location.replace((baseDir + file).replace(/\/\/{2,}/g,'/'));
      }
      const mq = window.matchMedia('(min-width: 640px)');
      let ticking = false;
      function check(){
        if (ticking) return; ticking = true;
        requestAnimationFrame(() => {
          const isDesktop = mq.matches;
          // Debug log
          console.log('Routing:', isDesktop ? 'Desktop → Guest.html' : 'Mobile → Guest-mobile.html');
          if (isDesktop && isOnBase(MOBILE_BASE)) {
            goToBase(DESKTOP_BASE);
          }
          // If mobile and on Guest-mobile.html, do nothing (stay)
          ticking = false;
        });
      }
      if (mq.addEventListener) mq.addEventListener('change', check, {passive:true});
      else if (mq.addListener) mq.addListener(check);
      window.addEventListener('resize', check,   {passive:true});
      window.addEventListener('orientationchange', check, {passive:true});
      document.addEventListener('DOMContentLoaded', check);
      setTimeout(check, 120);
      let kicks = 0; const kickTimer = setInterval(()=>{ kicks++; check(); if (kicks>10) clearInterval(kickTimer); }, 200);
      window.addEventListener('pageshow', check, {passive:true});
      document.addEventListener('visibilitychange', check, {passive:true});
    })();

    // ===== Guestbook 데이터 =====
    const messagesPerPage = 6; // 1열 기준 6개(스크롤 최소화)
    let messages = [];
    let currentPage = 1;

    function escHtml(str){
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    function escAttr(str){ return escHtml(str); }

    function renderMessages(){
      const list = document.getElementById('messageList');
      const pager = document.getElementById('pagination');
      list.innerHTML = '';
      pager.innerHTML = '';

      const start = (currentPage - 1) * messagesPerPage;
      const end   = start + messagesPerPage;
      const pageItems = messages.slice(start, end);

      pageItems.forEach((item, iLocal) => {
        const idx = start + iLocal;
        const el = document.createElement('article');
        el.className = 'card';
        if (item.editing){
          el.innerHTML = `
            <form class="edit-form" data-index="${idx}">
              <input type="text" id="edit-name-${idx}" value="${escAttr(item.name)}" placeholder="To" required />
              <input type="text" id="edit-from-${idx}" value="${escAttr(item.from || '')}" placeholder="From" required />
              <textarea id="edit-message-${idx}" required>${escHtml(item.message)}</textarea>
              <div class="actions" style="display:flex; position:static; gap:8px; margin-top:8px;">
                <button type="submit" class="mini">저장</button>
                <button type="button" class="mini cancel-btn">취소</button>
                <button type="button" class="mini delete-btn" data-index="${idx}">삭제</button>
              </div>
            </form>`;
        } else {
          el.innerHTML = `
            <button class="edit-toggle" aria-label="수정 메뉴 열기">✏️</button>
            <div class="to">To · ${escHtml(item.name)}</div>
            <div class="msg">${escHtml(item.message).replace(/\n/g,'<br>')}</div>
            <div class="from">From · ${escHtml(item.from || item.name)}</div>
            <div class="actions">
              <button class="mini edit-btn"   data-index="${idx}">수정</button>
              <button class="mini delete-btn" data-index="${idx}">삭제</button>
            </div>`;
        }
        list.appendChild(el);
      });

      const pageCount = Math.max(1, Math.ceil(messages.length / messagesPerPage));
      for (let i=1; i<=pageCount; i++){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'page' + (i===currentPage ? ' active' : '');
        btn.textContent = i;
        btn.addEventListener('click', () => { currentPage = i; renderMessages(); });
        pager.appendChild(btn);
      }
    }

    // 폼 제출
    document.getElementById('guestForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.currentTarget;
      const data = new FormData(form);
      if (!data.get('form-name')) data.set('form-name','guestbook');

      const body = new URLSearchParams();
      for (const [k,v] of data.entries()) body.append(k, v);

      try{
        await fetch('/', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: body.toString() });
        const name = data.get('name'); const message = data.get('message'); const from = data.get('from');
        messages.unshift({ name, message, from });
        try{
          const cached = JSON.parse(localStorage.getItem('guestbook-cache') || '[]');
          cached.unshift({ name, message, from, _ts: Date.now() });
          localStorage.setItem('guestbook-cache', JSON.stringify(cached.slice(0,200)));
        }catch(_){}
        currentPage = 1; renderMessages(); form.reset();
        alert('작성되었습니다!');
      }catch(err){
        console.error('submit failed', err);
        alert('제출 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
      }
    });

    // 글쓰기 토글
    (function(){
      const btn = document.getElementById('toggleWriteForm');
      const box = document.getElementById('writeBox');
      if (!btn || !box) return;
      btn.addEventListener('click', ()=>{
        const show = !box.classList.contains('show');
        box.classList.toggle('show', show);
        box.setAttribute('aria-hidden', show ? 'false' : 'true');
      });
    })();

    // 리스트 액션 (수정/삭제)
    document.getElementById('messageList').addEventListener('click', (e) => {
      const editBtn = e.target.closest('.edit-btn');
      const delBtn  = e.target.closest('.delete-btn');
      const toggle  = e.target.closest('.edit-toggle');
      if (toggle){
        const card = toggle.closest('.card');
        card && card.classList.toggle('show-actions');
        return;
      }
      if (editBtn){
        const idx = parseInt(editBtn.dataset.index, 10);
        if (!isNaN(idx) && messages[idx]){ messages[idx].editing = true; renderMessages(); }
        return;
      }
      if (delBtn){
        const idx = parseInt(delBtn.dataset.index, 10);
        if (!isNaN(idx) && messages[idx]){
          if (confirm('정말 삭제하시겠어요?')){
            messages.splice(idx, 1);
            try{
              const toCache = messages.map(({name,message,from}) => ({name,message,from,_ts:Date.now()}));
              localStorage.setItem('guestbook-cache', JSON.stringify(toCache));
            }catch(_){}
            const maxPage = Math.ceil(messages.length / messagesPerPage) || 1;
            if (currentPage > maxPage) currentPage = maxPage;
            renderMessages();
          }
        }
      }
    });

    // 인라인 편집 저장/취소
    document.getElementById('messageList').addEventListener('submit', (e) => {
      const form = e.target.closest('.edit-form'); if (!form) return;
      e.preventDefault();
      const idx = parseInt(form.dataset.index, 10); if (isNaN(idx) || !messages[idx]) return;
      const newName = document.getElementById(`edit-name-${idx}`).value;
      const newFrom = document.getElementById(`edit-from-${idx}`).value;
      const newMsg  = document.getElementById(`edit-message-${idx}`).value;
      messages[idx] = { name: newName, from: newFrom, message: newMsg, editing: false };
      renderMessages();
      try{
        const toCache = messages.map(({name,message,from}) => ({name,message,from,_ts:Date.now()}));
        localStorage.setItem('guestbook-cache', JSON.stringify(toCache));
      }catch(_){}
    });
    document.getElementById('messageList').addEventListener('click', (e) => {
      const cancel = e.target.closest('.cancel-btn');
      if (!cancel) return;
      const form = cancel.closest('.edit-form');
      const idx = form ? parseInt(form.dataset.index, 10) : -1;
      if (!isNaN(idx) && messages[idx]){ messages[idx].editing = false; renderMessages(); }
    });

    // 초기 데이터 로드
    (async function loadInitial(){
      try{
        const res = await fetch('/api/guestbook', { cache:'no-store' });
        if (res.ok){
          const rows = await res.json();
          messages = Array.isArray(rows) ? rows.map(r => ({
            name: r.name || '', message: r.message || '', from: r.from || (r.name || '')
          })) : [];
          currentPage = 1; renderMessages(); return;
        }
      }catch(_){}
      try{
        const cached = JSON.parse(localStorage.getItem('guestbook-cache') || '[]');
        messages = cached.map(r => ({ name:r.name, message:r.message, from:r.from }));
      }catch(_){ messages = []; }
      currentPage = 1; renderMessages();
    })();
  </script>
</body>
</html>